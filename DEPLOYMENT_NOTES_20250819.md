# 🚨 本番移行時の重要注意事項

## 作業日: 2025年8月19日
## 状況: 開発環境で旅先方面機能完成、動作確認完了

---

## ✅ 完了した作業

### 1. **旅先方面機能の実装**
- TripForm.jsx: 13の旅先方面選択メニュー追加
- TripList.jsx: カレンダー表示に旅先方面を追加  
- TripDetail.jsx: 詳細表示に旅先方面を追加
- Migration: `trips`テーブルに`destination`カラム追加（本番環境も適用済み）

### 2. **本番環境マスターデータの完全同期**
- main_purposes: 16件（観光、SUP・カヤック、等）
- default_items: 80件（目的別推奨持ち物）
- travel_rules: 62件（ルール・マナー情報）
- sub_purposes: 11件（重複解消、クリーンなデータ）

### 3. **問題解決**
- 持ち物表示: 本番マスターデータ同期で解決
- ルール・マナータイムアウト: travel_rulesデータ同期で解決
- サブ目的重複: 本番環境の正しいデータで解決
- 旅先方面表示: destinationカラム追加とRLS調整で解決

---

## 🚨 **本番移行時の必須確認事項**

### **⚠️ RLS（Row Level Security）設定の重要注意**

#### **現在の開発環境状況**
```sql
-- 開発環境では動作テストのため一時的に無効化
ALTER TABLE trips DISABLE ROW LEVEL SECURITY;
```

#### **本番移行前に必須の作業**
```sql
-- 本番環境では必ずRLSを有効化する
ALTER TABLE trips ENABLE ROW LEVEL SECURITY;

-- 既存のRLSポリシーを確認
SELECT tablename, policyname, cmd, qual 
FROM pg_policies 
WHERE tablename = 'trips';

-- 予想されるポリシー:
-- Users can view own trips   | SELECT | (auth.uid() = user_id)
-- Users can insert own trips | INSERT | 
-- Users can update own trips | UPDATE | (auth.uid() = user_id)  
-- Users can delete own trips | DELETE | (auth.uid() = user_id)
```

#### **🔥 絶対に忘れてはいけない確認項目**
1. **RLS有効化**: `trips`テーブルでRLSが有効になっているか
2. **認証動作**: ログイン状態でのみデータ取得可能か
3. **user_id設定**: 新規作成された旅行に正しいuser_idが設定されるか
4. **セキュリティテスト**: 他のユーザーのデータが表示されないか

---

## 📋 **本番移行チェックリスト**

### **事前確認**
- [ ] 本番環境の`trips`テーブルに`destination`カラムが存在する
- [ ] 本番環境でRLSが正しく設定されている  
- [ ] 既存ユーザーの旅行データに影響がない

### **移行作業**
- [ ] フロントエンドコードのデプロイ
- [ ] 認証フローのテスト
- [ ] 新機能（旅先方面）の動作テスト
- [ ] 既存機能の回帰テスト

### **移行後確認**
- [ ] ユーザー登録・ログインが正常
- [ ] 旅行作成時に旅先方面が選択可能
- [ ] カレンダー表示で旅先方面が表示される
- [ ] 他のユーザーのデータが見えない（セキュリティ）
- [ ] 持ち物・ルール機能が正常動作

---

## 🎯 **完成した新機能**

### **旅先方面選択**
13の方面から選択可能:
- 北海道（道北、道東、道南、道央）
- 東北方面、北陸方面、関東方面、甲信越地方
- 中部・東海方面、近畿方面、中国方面、四国方面、九州方面

### **表示場所**
1. **旅行作成フォーム**: ドロップダウンで選択
2. **年間カレンダー**: 旅行タイトル下に「📍 方面名」表示
3. **旅行詳細**: タイトル下に「📍 旅先方面: 方面名」表示

---

## 💾 **バックアップと復旧**

### **現在の状態保存**
- 開発環境のデータベース状態: 本番マスターデータと完全同期済み
- Migration履歴: `/supabase/migrations/` 内に全て記録
- 設定ファイル: `.env.local`（開発用）、`.env`（本番用）

### **問題時の復旧手順**
1. Migration履歴からデータベース状態を復元
2. RLS設定の確認と修正
3. マスターデータの再同期（本文書の手順に従う）

---

## 👨‍💻 **作業者情報**
- **実装日**: 2025年8月19日
- **作業者**: Claude Code + syokota
- **テスト環境**: ローカル開発環境（localhost:3000）
- **本番環境**: https://travel-journal-ochre-two.vercel.app

---

## 📞 **移行時サポート**
本番移行で問題が発生した場合、以下の情報を確認:
1. ブラウザの開発者ツールでAPIエラーを確認
2. Supabase管理画面でRLS設定を確認
3. 認証状態（auth.uid()）を確認
4. このドキュメントのチェックリストを再確認