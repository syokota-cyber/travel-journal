# 🚨 Claude Code API安全運用規則 - Travel Journal プロジェクト

## ⚡ 重大事故防止のための鉄則

### **🛑 Rule 1: API認証は1回で決める**
- **❌ 絶対禁止**: API キーの試行錯誤・複数回テスト
- **✅ 必須手順**: 公式ドキュメント確認 → 1回限りの正確な設定
- **⚠️ 緊急時でも**: パニックせず、必ず確認してから実行

### **🛑 Rule 2: サードパーティサービス制限の理解**
- **Supabase**: API制限、メール制限 → **違反で即座にプロジェクト停止**
- **Vercel**: デプロイ制限、帯域幅制限
- **事前学習**: 各サービスの制限ポリシーを必ず理解

### **🛑 Rule 3: エラー発生時の正しい対応**
```
❌ 危険な対応:
エラー発生 → 別のキーで試行 → また試行 → 制限発動

✅ 正しい対応:
エラー発生 → 詳細分析 → 公式確認 → 1回修正
```

## 📊 2025年8月8日重大事故の記録

### **経緯**
1. "Invalid login credentials" エラー発生
2. Claude Codeが**4回連続**で異なるAPIキーを試行
3. publishable key と anon key を混同
4. Supabaseがセキュリティメール大量送信
5. バウンス率上昇でプロジェクト制限発動

### **損失**
- **48時間のサービス停止**
- 開発作業の完全中断
- ユーザー体験の悪化

### **教訓**
- **公式ドキュメントを最初に確認すれば10分で解決だった**
- パニック対応が問題を10倍悪化させた
- 1回で正しく設定する重要性

## ⚡ 緊急時対応プロセス

### **API認証エラー発生時**
```bash
# Step 1: エラー詳細記録（試行前に必須）
console.error("完全なエラー情報:", error);

# Step 2: 公式ドキュメント確認
# Supabase → Settings → API → 正しいキー形式確認

# Step 3: 現在設定のバックアップ
echo "現在のキー:" $REACT_APP_SUPABASE_ANON_KEY

# Step 4: 1回限りの修正
# 公式から取得した正しいキーを設定

# Step 5: 単一機能テスト
# ログイン機能のみで動作確認
```

### **制限発動時の対応**
1. **即座停止**: これ以上のAPI試行を完全停止
2. **状況分析**: 制限内容と原因の詳細特定
3. **復旧計画**: Migration を使用した一括復旧準備
4. **サポート連絡**: 必要に応じて公式サポート

## 🔧 技術仕様

### **正しいSupabase設定**
```javascript
// 正しいanon key形式（JWT）
REACT_APP_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

// 間違った形式（publishable key）
❌ REACT_APP_SUPABASE_ANON_KEY=sb_publishable_xxx...
```

### **環境変数設定場所**
- 開発環境: `.env`
- 本番環境: Vercel Dashboard → Environment Variables

## 📋 作業前チェックリスト

**API変更作業前に必ず確認:**
- [ ] この操作は本番環境に影響するか？
- [ ] 正しいキー形式を公式で確認したか？
- [ ] 現在の設定をバックアップしたか？
- [ ] 1回で正しく設定する準備はできているか？

**エラー発生時に必ず実行:**
- [ ] エラーの完全な記録を取ったか？
- [ ] 公式ドキュメントを確認したか？
- [ ] 試行錯誤せず1回で修正する準備はできているか？

## 🎯 今後の運用方針

### **開発環境**
- Migration を使用したデータベース管理
- API変更は慎重に1回ずつ
- エラー時は必ずこのルールブック確認

### **本番環境**
- Vercel環境変数での安全な管理
- デプロイ前の動作確認必須
- 制限解除後のMigration一括復旧

---

**📅 作成**: 2025年8月9日  
**⚡ 緊急度**: 最高（即座適用必須）  
**🎯 目的**: API制限事故の完全防止  

**このルールは毎回のAPI作業前に必ず確認すること**

---

# 📂 プロジェクト管理規則 - 統合版

## 🚨 ファイル・ディレクトリ管理の鉄則

### **🛑 絶対禁止事項**
```
❌ ルートディレクトリでの一時ファイル作成:
- test-*.js, check-*.js, debug-*.*, temp-*.*
- *_V1.md, *_V2.md (バージョン番号付きドキュメント)
- connection-test.js, simple-test.js (接続テスト)

❌ 重複ファイルの同時存在:
- Component.js + Component.jsx → .jsx のみ保持
- index.js + index.jsx → .jsx のみ保持

❌ 命名規則違反:
- 日本語ファイル名、スペース含有、特殊文字使用
```

### **✅ 標準ディレクトリ構造**
```
travel-journal/
├── docs/           # ドキュメント専用（15個以下）
├── src/            # Reactアプリ（.jsx のみ）
├── supabase/       # データベース設定
├── package.json    # 必須設定ファイル
└── README.md       # プロジェクト概要
```

### **📊 ファイル数制限アラート**
```
🚨 緊急対応必要:
- MDファイル 20個超過 (現在基準: 10個)
- JSファイル 15個超過 (現在基準: 7個)

🟡 注意レベル:  
- MDファイル 15個超過
- JSファイル 10個超過
```

### **🧹 セッション終了時必須チェック**
```bash
# 一時ファイル削除確認
find . -name "test-*" -o -name "debug-*" -o -name "temp-*"

# 重複ファイル確認  
find src -name "*.js" | grep -v node_modules

# ファイル数確認
echo "MD: $(find . -name '*.md' -not -path './node_modules/*' | wc -l)"
echo "JS: $(find . -name '*.js' -not -path './node_modules/*' | wc -l)"
```

### **⚡ 緊急クリーンアップコマンド**
```bash
# ファイル数が基準値超過時の緊急対応
find . -name "test-*" -o -name "debug-*" -o -name "temp-*" -delete
find src -name "*.js" -exec rm {} \; # .jsx存在時のみ
```

## 📋 統合作業チェックリスト

### **新規ファイル作成時**
- [ ] **API安全規則確認**: 公式ドキュメント確認済み
- [ ] **適切ディレクトリ**: docs/, src/, supabase/ のいずれか  
- [ ] **命名規則準拠**: PascalCase/.jsx, UPPER_CASE/.md
- [ ] **重複チェック**: 同名・同機能ファイル未存在

### **ファイル編集時**
- [ ] **最新版確認**: 編集対象が最新版
- [ ] **一時ファイル禁止**: temp-, test-, debug- ファイル未作成
- [ ] **API変更時**: 1回限りの正確な設定変更

### **セッション終了時**  
- [ ] **一時ファイル削除**: 不要ファイル完全削除
- [ ] **ファイル数確認**: 基準値内 (MD≤15, JS≤10)
- [ ] **構造確認**: 標準ディレクトリ構造維持

**📖 詳細**: `docs/PROJECT_MANAGEMENT_RULES.md` 参照必須